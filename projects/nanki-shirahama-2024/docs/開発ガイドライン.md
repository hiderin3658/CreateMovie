# 南紀白浜プロジェクト - 開発ガイドライン

## 📐 設計方針

### 基本原則

このプロジェクトは、**CreateMovieプロジェクトのコアシステムを基盤として、プラグインアーキテクチャで機能拡張する設計**を採用しています。

#### 1. コアシステムの活用

**必須要件**: 今後の機能追加は、**必ずコアシステム (`core/`) を使用する**こと。

```
コアシステム (core/)
  ├── base/                    # 基底クラス
  ├── video/                   # 動画生成
  ├── analysis/                # ビジュアル解析
  └── music/                   # 音楽生成

↓ 使用

プロジェクト固有 (projects/nanki-shirahama-2024/)
  ├── plugins/                 # プラグインで拡張
  └── ツール類                  # プロジェクト特有のユーティリティ
```

**理由**:
- コアシステムの改善が自動的に反映される
- 他のプロジェクトと知見を共有できる
- コードの重複を避けられる
- 保守性・拡張性が高い

#### 2. Claude Skills で動作させる前提

すべての機能は、**Claude Code の Claude Skills として動作する前提で設計**すること。

**要件**:
- コマンドライン引数で動作可能
- スタンドアロンで実行可能
- エラーハンドリングが適切
- ヘルプメッセージが充実

**例**:
```bash
# Claude Skillsから呼び出される想定
python generate_tourism_videos_v2.py "ストーリー" --options
```

#### 3. プラグインアーキテクチャ

プロジェクト固有の機能は、**プラグインとして実装**すること。

**実装例**:
```python
from core.base.plugin import BasePlugin

class MyFeaturePlugin(BasePlugin):
    def supports_stage(self, stage: str) -> bool:
        return stage in ['pre_generation', 'post_generation']

    def process(self, data: Dict, stage: str) -> Dict:
        # プロジェクト固有の処理
        return data
```

**プラグインで実装すべき機能**:
- プロジェクト特有の制約チェック（例: 素材制約）
- ドメイン固有の最適化（例: 観光ストーリー最適化）
- カスタムバリデーション
- 特殊なプリ/ポスト処理

---

## 🏗️ アーキテクチャ

### レイヤー構造

```
┌─────────────────────────────────────────┐
│  ユーザーインターフェース層               │
│  - generate_tourism_videos_v2.py        │
│  - Claude Skills                        │
└─────────────────────────────────────────┘
              ↓
┌─────────────────────────────────────────┐
│  プラグイン層                            │
│  - ShirahamaTourismPlugin               │
│  - その他のカスタムプラグイン             │
└─────────────────────────────────────────┘
              ↓
┌─────────────────────────────────────────┐
│  コアシステム層                          │
│  - CoreStoryboardGenerator              │
│  - ImageGenerator                       │
│  - MusicGenerator                       │
│  - VisualAnalyzer                       │
└─────────────────────────────────────────┘
              ↓
┌─────────────────────────────────────────┐
│  基盤層                                  │
│  - BaseVideoGenerator                   │
│  - BasePlugin                           │
└─────────────────────────────────────────┘
```

### 責任分担

| レイヤー | 責任 | 実装場所 |
|---------|------|---------|
| ユーザーIF層 | CLI、パラメータ処理、ワークフロー制御 | `generate_*.py` |
| プラグイン層 | プロジェクト固有のロジック、制約、最適化 | `plugins/` |
| コアシステム層 | 汎用的な動画生成機能 | `core/` |
| 基盤層 | 抽象クラス、共通インターフェース | `core/base/` |

---

## 🚀 機能追加の手順

### ステップ1: 既存機能の確認

新機能を追加する前に、コアシステムに類似機能がないか確認：

```bash
# コアシステムのコードを確認
ls -la ../../core/
cat ../../core/video/storyboard_generator.py
```

### ステップ2: 実装方法の決定

| 機能の種類 | 実装方法 |
|-----------|---------|
| 汎用的な機能 | コアシステムに追加（PRを出す） |
| プロジェクト固有の機能 | プラグインとして実装 |
| ユーティリティ | プロジェクトディレクトリに追加 |

### ステップ3: プラグインの実装

```python
# plugins/my_feature_plugin.py

from core.base.plugin import BasePlugin

class MyFeaturePlugin(BasePlugin):
    def __init__(self):
        super().__init__(name="my_feature")

    def setup(self, generator):
        super().setup(generator)
        print(f"[{self.name}] Plugin initialized")

    def supports_stage(self, stage: str) -> bool:
        return stage in ['pre_generation', 'post_generation']

    def process(self, data: Dict, stage: str) -> Dict:
        if stage == 'pre_generation':
            # 生成前の処理
            pass
        elif stage == 'post_generation':
            # 生成後の処理
            pass
        return data
```

### ステップ4: メインスクリプトへの統合

```python
# generate_tourism_videos_v2.py

from plugins.my_feature_plugin import MyFeaturePlugin

# プラグインを追加
my_plugin = MyFeaturePlugin()
generator.add_plugin(my_plugin)
```

### ステップ5: テストと文書化

- テストスクリプトを作成
- ドキュメントを更新（`docs/` 以下）
- README.md に使用例を追記

---

## 📝 コーディング規約

### Python スタイル

- PEP 8 に準拠
- 型ヒントを使用
- Docstring を記述（Google スタイル）

```python
def generate_video(story: str, duration: int = 30) -> Dict:
    """
    動画を生成する

    Args:
        story: ストーリーの説明
        duration: 動画の長さ（秒）

    Returns:
        生成された動画データ
    """
    pass
```

### ファイル構成

```
plugins/
  ├── __init__.py              # プラグインのエクスポート
  ├── feature_plugin.py        # 機能ごとに分割
  └── another_plugin.py

docs/
  ├── 開発ガイドライン.md      # このファイル
  ├── プロジェクト仕様書.md
  └── その他のドキュメント.md

tests/                         # テストは別ディレクトリ
  ├── test_plugins.py
  └── test_integration.py
```

### コミットメッセージ

Conventional Commits 形式を使用：

```
feat: 新機能追加
fix: バグ修正
refactor: リファクタリング
docs: ドキュメント更新
test: テスト追加
chore: その他の変更
```

---

## 🔌 プラグイン開発ガイド

### プラグインのライフサイクル

1. **初期化** (`__init__`)
   - プラグイン名の設定
   - 設定の初期化

2. **セットアップ** (`setup`)
   - ジェネレーターへの登録
   - 初期処理

3. **処理** (`process`)
   - ステージごとの処理実行
   - データの加工・検証

### 利用可能なステージ

| ステージ | タイミング | 用途 |
|---------|-----------|-----|
| `pre_generation` | 生成前 | 入力データの最適化、コンテキスト追加 |
| `post_generation` | 生成後 | 制約チェック、警告、データ加工 |
| `validation` | バリデーション時 | データ検証、エラーチェック |
| `camera_planning` | カメラワーク計画時 | カメラワークの最適化 |

### プラグイン実装のベストプラクティス

1. **単一責任の原則**: 1つのプラグインは1つの機能に特化
2. **設定の外部化**: ハードコードせず、設定ファイルやパラメータで制御
3. **エラーハンドリング**: 適切な例外処理とロギング
4. **テスト可能性**: 独立してテストできる設計

---

## 🧪 テスト戦略

### テストの種類

1. **ユニットテスト**: プラグイン単体のテスト
2. **統合テスト**: コアシステムとの統合テスト
3. **エンドツーエンドテスト**: 全体のワークフローテスト

### テスト例

```python
# tests/test_shirahama_plugin.py

def test_material_constraints():
    plugin = ShirahamaTourismPlugin()

    # 禁止されたカメラワークが検出されることを確認
    data = {'cuts': [{'camera_movement': 'tracking'}]}
    result = plugin.process(data, 'post_generation')

    assert 'plugin_warnings' in result
    assert len(result['plugin_warnings']) > 0
```

---

## 📚 ドキュメント管理

### ドキュメント構成

```
nanki-shirahama-2024/
├── README.md                          # プロジェクトの概要（エントリーポイント）
└── docs/
    ├── 開発ガイドライン.md             # このファイル（設計方針）
    ├── プロジェクト仕様書.md
    ├── クイックスタート.md
    ├── コアシステム統合ガイド.md
    ├── 素材分類ガイド.md
    └── 写真配置ガイド.md
```

### ドキュメント更新ルール

- 機能追加時は必ずドキュメントも更新
- 日本語ファイル名を使用（わかりやすさ優先）
- Markdownフォーマットを使用
- 図やコード例を積極的に使用

---

## 🔄 今後の拡張予定

### Phase 1: 基本機能の完成（現在）
- ✅ コアシステム統合
- ✅ 素材制約プラグイン
- ✅ 観光ストーリー最適化

### Phase 2: 自動化の強化
- 🔲 キャラクター生成の自動化
- 🔲 背景のアニメ化処理
- 🔲 I2V生成の統合

### Phase 3: Claude Skills 統合
- 🔲 skill.yaml の作成
- 🔲 Claude Code からの呼び出し最適化
- 🔲 インタラクティブモードの追加

---

## ⚠️ 注意事項

### やってはいけないこと

❌ コアシステムを無視して独自実装を作る
❌ プラグインなしでプロジェクト固有の処理をメインスクリプトに書く
❌ ハードコードで制約を実装する
❌ ドキュメントを更新せずにコードを変更する

### 推奨される実装

✅ コアシステムの機能を最大限活用する
✅ プロジェクト固有の処理はプラグインで実装する
✅ 設定ファイルで動作を制御する
✅ コード変更と同時にドキュメントも更新する

---

## 🤝 コントリビューション

このプロジェクトに貢献する場合：

1. この開発ガイドラインを熟読
2. コアシステムのドキュメントを確認
3. プラグインアーキテクチャを理解
4. テストとドキュメントを含めてPR作成

---

## 📞 質問・サポート

- プロジェクト仕様: `docs/プロジェクト仕様書.md`
- コアシステム: `../../core/README.md`
- 既存プラグイン: `plugins/shirahama_tourism_plugin.py` を参考に

---

**最終更新**: 2024-11-08
**バージョン**: 2.0
**プロジェクト**: nanki-shirahama-2024
